<mat-toolbar color="primary">
  <!-- Desktop Logo & Title -->
  <div class="desktop-header" (click)="goToHome()">
    <button mat-icon-button class="logo-button">
      <img src="assets/images/logo-32x32.png" alt="CampusLibra" class="logo" />
    </button>
    <span class="app-title">CampusLibra</span>
  </div>

  <span class="spacer"></span>

  <!-- Desktop Navigation (hidden on mobile) -->
  <div class="nav-links desktop-nav" *ngIf="currentUser">
    <!-- Member Navigation -->
    <ng-container *ngIf="userRole === 'member'">
      <button mat-button routerLink="/books" routerLinkActive="active-link">
        Browse Books
      </button>
      <button
        mat-button
        routerLink="/member/my-borrows"
        routerLinkActive="active-link"
      >
        My Borrows
      </button>
      <button
        mat-button
        routerLink="/member/my-reservations"
        routerLinkActive="active-link"
      >
        Reservations
      </button>
      <button
        mat-button
        routerLink="/member/my-fines"
        routerLinkActive="active-link"
      >
        Fines
      </button>
    </ng-container>

    <!-- Librarian Navigation -->
    <ng-container *ngIf="userRole === 'librarian'">
      <button
        mat-button
        routerLink="/librarian/process-returns"
        routerLinkActive="active-link"
      >
        Process Returns
      </button>
      <button
        mat-button
        routerLink="/librarian/pending-pickups"
        routerLinkActive="active-link"
      >
        Pending Pickups
      </button>
      <button
        mat-button
        routerLink="/librarian/member-management"
        routerLinkActive="active-link"
      >
        Members
      </button>
      <button mat-button routerLink="/books" routerLinkActive="active-link">
        Inventory
      </button>
    </ng-container>

    <!-- Admin Navigation -->
    <ng-container *ngIf="userRole === 'admin'">
      <button
        mat-button
        routerLink="/admin/books-manage"
        routerLinkActive="active-link"
      >
        Manage Books
      </button>
      <button
        mat-button
        routerLink="/admin/users-manage"
        routerLinkActive="active-link"
      >
        Manage Users
      </button>
      <button
        mat-button
        routerLink="/admin/system-settings"
        routerLinkActive="active-link"
      >
        Settings
      </button>
      <button
        mat-button
        routerLink="/admin/audit-trail"
        routerLinkActive="active-link"
      >
        Audit Trail
      </button>
    </ng-container>
  </div>

  <!-- Dashboard Link (Desktop) -->
  <button mat-button (click)="goToDashboard()" class="desktop-nav" *ngIf="currentUser">
    <mat-icon>dashboard</mat-icon>
    Dashboard
  </button>

  <!-- User Section (desktop) -->
  <div class="user-section desktop-user" *ngIf="currentUser">
    <!-- Notification Badge with Dropdown -->
    <button
      mat-icon-button
      class="notification-button"
      [matMenuTriggerFor]="notificationMenu"
      aria-label="Notifications"
      [attr.aria-badge]="unreadNotifications > 0 ? unreadNotifications : null"
    >
      <mat-icon>notifications</mat-icon>
      <span
        class="notification-badge"
        *ngIf="unreadNotifications > 0"
        aria-live="polite"
      >
        {{ unreadNotifications > 9 ? "9+" : unreadNotifications }}
      </span>
    </button>
    <!-- User Menu Button (desktop only) -->
    <button mat-icon-button [matMenuTriggerFor]="userMenu">
      <mat-icon>account_circle</mat-icon>
    </button>
  </div>

  <!-- Mobile Notification Button -->
  <button
    mat-icon-button
    class="notification-button mobile-notification"
    [matMenuTriggerFor]="notificationMenu"
    aria-label="Notifications"
    *ngIf="currentUser && isMobileView()"
    [attr.aria-badge]="unreadNotifications > 0 ? unreadNotifications : null"
  >
    <mat-icon>notifications</mat-icon>
    <span
      class="notification-badge"
      *ngIf="unreadNotifications > 0"
      aria-live="polite"
    >
      {{ unreadNotifications > 9 ? "9+" : unreadNotifications }}
    </span>
  </button>

  <!-- Mobile Menu Button -->
  <button
    mat-icon-button
    class="mobile-menu-button"
    (click)="toggleMobileMenu()"
    *ngIf="currentUser && isMobileView()"
    aria-label="Toggle mobile menu"
    [attr.aria-expanded]="isMobileMenuOpen"
  >
    <mat-icon>{{ isMobileMenuOpen ? "close" : "menu" }}</mat-icon>
  </button>

  <!-- Notification Menu (shared for desktop and mobile) -->
  <mat-menu #notificationMenu="matMenu" class="notification-menu">
    <div
      class="notification-header"
      (click)="goToNotifications(); $event.stopPropagation()"
    >
      <span class="clickable">Notifications</span>
      <button
        mat-icon-button
        (click)="markAllAsRead(); $event.stopPropagation()"
        *ngIf="unreadNotifications > 0"
      >
        <mat-icon>done_all</mat-icon>
      </button>
    </div>

    <div class="notifications-list">
      <div
        *ngIf="(unreadNotifications$ | async)?.length === 0"
        class="no-notifications"
      >
        No new notifications
      </div>

      <button
        mat-menu-item
        *ngFor="let notification of unreadNotifications$ | async"
        (click)="markNotificationAsRead(notification.id)"
        [class.unread]="!notification.isRead"
      >
        <mat-icon
          [color]="
            notification.type === 'error'
              ? 'warn'
              : notification.type === 'success'
              ? 'primary'
              : ''
          "
        >
          {{ getIconForType(notification.type) }}
        </mat-icon>
        <div class="notification-content">
          <span class="notification-title">{{ notification.title }}</span>
          <span class="notification-message">{{ notification.message }}</span>
          <span class="notification-time">{{
            notification.createdAt | date : "short"
          }}</span>
        </div>
      </button>
    </div>
  </mat-menu>

  <!-- User Menu (for desktop only) -->
  <mat-menu #userMenu="matMenu">
    <button mat-menu-item routerLink="/member/profile">
      <mat-icon>person</mat-icon>
      <span>{{ currentUser?.name || "Profile" }}</span>
    </button>
    <button mat-menu-item (click)="logout()">
      <mat-icon>exit_to_app</mat-icon>
      <span>Logout</span>
    </button>
  </mat-menu>
</mat-toolbar>

<!-- Mobile Navigation Drawer -->
<mat-drawer-container
  class="mobile-drawer-container"
  *ngIf="currentUser && isMobileMenuOpen"
>
  <mat-drawer mode="side" opened class="mobile-drawer">
    <div class="mobile-user-info">
      <h3>{{ currentUser?.name }}</h3>
      <p>{{ userRole | titlecase }}</p>
    </div>

    <!-- Mobile Nav Links -->
    <div class="mobile-nav-links">
      <!-- Member Links -->
      <ng-container *ngIf="userRole === 'member'">
        <button mat-button routerLink="/books" (click)="closeMobileMenu()">
          <mat-icon>book</mat-icon>
          Browse Books
        </button>
        <button
          mat-button
          routerLink="/member/my-borrows"
          (click)="closeMobileMenu()"
        >
          <mat-icon>library_books</mat-icon>
          My Borrows
        </button>
        <button
          mat-button
          routerLink="/member/my-reservations"
          (click)="closeMobileMenu()"
        >
          <mat-icon>event_seat</mat-icon>
          Reservations
        </button>
        <button
          mat-button
          routerLink="/member/my-fines"
          (click)="closeMobileMenu()"
        >
          <mat-icon>attach_money</mat-icon>
          Fines
        </button>
      </ng-container>

      <!-- Librarian Links -->
      <ng-container *ngIf="userRole === 'librarian'">
        <button
          mat-button
          routerLink="/librarian/process-returns"
          (click)="closeMobileMenu()"
        >
          <mat-icon>undo</mat-icon>
          Process Returns
        </button>
        <button
          mat-button
          routerLink="/librarian/pending-pickups"
          (click)="closeMobileMenu()"
        >
          <mat-icon>shopping_bag</mat-icon>
          Pending Pickups
        </button>
        <button
          mat-button
          routerLink="/librarian/member-management"
          (click)="closeMobileMenu()"
        >
          <mat-icon>people</mat-icon>
          Members
        </button>
        <button mat-button routerLink="/books" (click)="closeMobileMenu()">
          <mat-icon>inventory_2</mat-icon>
          Inventory
        </button>
      </ng-container>

      <!-- Admin Links -->
      <ng-container *ngIf="userRole === 'admin'">
        <button
          mat-button
          routerLink="/admin/books-manage"
          (click)="closeMobileMenu()"
        >
          <mat-icon>edit</mat-icon>
          Manage Books
        </button>
        <button
          mat-button
          routerLink="/admin/users-manage"
          (click)="closeMobileMenu()"
        >
          <mat-icon>manage_accounts</mat-icon>
          Manage Users
        </button>
        <button
          mat-button
          routerLink="/admin/system-settings"
          (click)="closeMobileMenu()"
        >
          <mat-icon>settings</mat-icon>
          Settings
        </button>
        <button
          mat-button
          routerLink="/admin/audit-trail"
          (click)="closeMobileMenu()"
        >
          <mat-icon>history</mat-icon>
          Audit Trail
        </button>
      </ng-container>

      <!-- Profile & Logout -->
      <button
        mat-button
        routerLink="/member/profile"
        (click)="closeMobileMenu()"
      >
        <mat-icon>person</mat-icon>
        Profile
      </button>
      <button mat-button (click)="logoutAndClose()">
        <mat-icon>exit_to_app</mat-icon>
        Logout
      </button>
    </div>
  </mat-drawer>
</mat-drawer-container>
